<!DOCTYPE html>
<html>

<head>
  <title> ibi Ocean Dome - Smart Height </title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script>
    window.AFRAME_ASYNC = true;
  </script>
  
  <script type="importmap">
      {
        "imports": {
          "aframe": "https://aframe.io/releases/1.7.0/aframe.module.min.js",
          "three": "https://cdn.jsdelivr.net/npm/super-three@0.173.4/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/super-three@0.173.4/examples/jsm/",
          "sphere-collider": "https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/components/sphere-collider.min.js",
          "aframe-extras-controls": "https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.controls.min.js",
          "handy-controls": "https://cdn.jsdelivr.net/npm/handy-work/build/handy-controls.min.js"
        }
      }
    </script>

  <script>
    window.Util = {};
  </script>

  <script type="module">
    import "aframe";
    import * as THREE from "three";
    import "sphere-collider";
    import "aframe-extras-controls";
    import "handy-controls";

    // --- 1. Custom HUD Component ---
    AFRAME.registerComponent('height-readout', {
      init: function () {
        this.camera = document.querySelector('#head');
        this.rig = document.querySelector('#cameraRig');
        this.adjuster = document.querySelector('#camera-height-adjuster');
        this.displayText = this.el;
        
        this.worldPos = new THREE.Vector3();
        this.localPos = new THREE.Vector3();
      },
      tick: function () {
        if (!this.camera || !this.rig) return;

        // Global
        this.camera.object3D.getWorldPosition(this.worldPos);
        
        // Rig Relative
        this.localPos.copy(this.worldPos);
        this.rig.object3D.worldToLocal(this.localPos);

        const relativeHeight = this.worldPos.y - 10.0;
        const adjusterHeight = this.adjuster ? this.adjuster.object3D.position.y : 0;

        const f = (n) => n.toFixed(2);

        const textOutput = 
          `:: TELEMETRY ::\n` +
          `Global Y: ${f(this.worldPos.y)}\n` +
          `Rig Rel Y: ${f(this.localPos.y)}\n` + 
          `Adj Offset: ${f(adjusterHeight)}\n` +
          `Target: 1.75m`;

        this.displayText.setAttribute('text', { value: textOutput });
      }
    });

    // --- 2. Smart Height Adjuster (Your Request) ---
    AFRAME.registerComponent('smart-height-adjuster', {
      schema: {
        targetHeight: { type: 'number', default: 1.75 }, 
        threshold: { type: 'number', default: 1.55 },    
        interval: { type: 'number', default: 5000 }      
      },

      init: function () {
        this.adjuster = this.el.querySelector('#camera-height-adjuster');
        this.camera = this.el.querySelector('[camera]');
        
        this.timer = 0;
        this.isActive = false; // Only active in VR

        // Listen for VR entry
        this.el.sceneEl.addEventListener('enter-vr', () => {
          this.isActive = true;
          // Initial check after 1 second to let sensors stabilize
          setTimeout(() => { this.checkHeight(); }, 1000); 
        });

        this.el.sceneEl.addEventListener('exit-vr', () => {
          this.isActive = false;
        });
      },

      tick: function (time, timeDelta) {
        if (!this.isActive || !this.adjuster || !this.camera) return;

        this.timer += timeDelta;

        if (this.timer >= this.data.interval) {
          this.checkHeight();
          this.timer = 0;
        }
      },

      checkHeight: function () {
        // Current Adjuster Offset
        const currentAdjusterY = this.adjuster.object3D.position.y;
        // Physical Camera Height (from headset)
        const currentCameraY = this.camera.object3D.position.y;

        // Total Height relative to Rig Floor
        const totalHeightWRT_Rig = currentAdjusterY + currentCameraY;

        // Logic: Only boost UP if below threshold
        if (totalHeightWRT_Rig < this.data.threshold) {
          // Calculate needed boost
          const difference = this.data.targetHeight - totalHeightWRT_Rig;
          const newAdjusterY = currentAdjusterY + difference;
          
          this.adjuster.object3D.position.y = newAdjusterY;
        }
      }
    });

    window.AFRAME.emitReady();
  </script>

  <a-scene vr-mode-ui="enabled: true" background="color: #050510" fog="type: exponential; color: #1a0b2e; density: 0.02">

    <a-assets>
      <a-mixin id="marker-text" text="align: center; width: 4; color: #FFF; font: roboto"></a-mixin>
      <a-mixin id="marker-line" geometry="primitive: box; depth: 0.02; height: 0.02; width: 1" material="color: #00ffcc; emissive: #00ffcc; emissiveIntensity: 0.5"></a-mixin>
    </a-assets>

    <!-- Environment -->
    <a-sky color="#0B0B15"></a-sky> 
    <a-entity id="stars" particle-system="preset: snow; color: #ffffff; particleCount: 5000; size: 1"></a-entity>
    <a-light type="directional" position="-5 20 10" intensity="0.8" color="#ffaa00" cast-shadow="true"></a-light>
    <a-light type="ambient" color="#220044" intensity="0.8"></a-light>

    <!-- Platform (Y=10) -->
    <a-cylinder position="0 9.95 0" radius="10" height="0.1" material="color: #111; roughness: 0.2;" shadow="receive: true">
      <a-circle rotation="-90 0 0" position="0 0.06 0" radius="9.9" material="src: #grid; transparent: true; opacity: 0.5; color: #00d9ff; wireframe: true"></a-circle>
      <a-torus radius="10" radius-tubular="0.05" rotation="90 0 0" position="0 0.05 0" material="color: #ff0055; emissive: #ff0055; emissiveIntensity: 2"></a-torus>
    </a-cylinder>

    <!-- Height Markers -->
    <a-entity position="0 10 -4">
      <a-cylinder height="3" radius="0.05" position="0 1.5 0" material="color: #333"></a-cylinder>
      <a-entity position="0 0.05 0" mixin="marker-line"></a-entity>
      <a-text value="0.0m (Floor)" position="0.6 0.05 0" color="#ff0055" width="4"></a-text>
      
      <a-entity position="0 1.55 0" mixin="marker-line" material="color: red"></a-entity>
      <a-text value="1.55m (Sit Threshold)" position="0.6 1.55 0" color="red" width="4"></a-text>

      <a-entity position="0 1.75 0" mixin="marker-line" material="color: #00ff00"></a-entity>
      <a-text value="1.75m (Stand Target)" position="0.6 1.75 0" color="#00ff00" width="4"></a-text>
    </a-entity>

    <!-- CAMERA RIG -->
    <!-- Added: smart-height-adjuster component -->
    <a-entity id="cameraRig" 
              position="0 10 0" 
              movement-controls="enabled: true; speed: 0.2; camera:#head;"
              smart-height-adjuster="targetHeight: 1.75; threshold: 1.55; interval: 5000">
      
     <!-- vertical variable height adjuster -->
     <a-entity id="camera-height-adjuster" position="0 0.5 0">

        <a-entity id="head" camera="active: true" look-controls position="0 1.6 0">
        
        <!-- HUD PANEL -->
        <a-entity position="0 -0.05 -1.1" rotation="-15 0 0">
            <a-box width="0.9" height="0.5" depth="0.01" 
                   material="color: #000; opacity: 0.7; transparent: true; metalness: 0.8; roughness: 0.2"
                   position="0 0 0">
                   <a-entity geometry="primitive: plane; width: 0.92; height: 0.52" position="0 0 -0.01" material="color: #00d9ff; shader: flat"></a-entity>
            </a-box>

            <a-text height-readout 
                    value="Init..." 
                    font="monoid"
                    align="center" 
                    width="1.6" 
                    color="#00ffcc"
                    position="0 0 0.02">
            </a-text>
        </a-entity>

      </a-entity>

     </a-entity>

      <a-entity id="hands" handy-controls="renderGamepad: any; materialOverride: both;" material="color: #FFDB58; metalness: 0.5; roughness: 0.3;"></a-entity>
    
    </a-entity>

  </a-scene>

</body>
</html>